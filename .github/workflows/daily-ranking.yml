name: Daily Ranking (Tech Books)

on:
  schedule:
    # JST 04:10 = UTC 19:10
    - cron: "10 19 * * *"
  workflow_dispatch:

env:
  # 調整用
  MIN_LIKES: "3"
  QIITA_PAGES: "10"
  # 任意（設定していなければ空のままでOK）
  QIITA_TOKEN: ${{ secrets.QIITA_TOKEN }}
  VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci || npm i

      - name: Collect tech books
        env:
          MIN_LIKES: ${{ env.MIN_LIKES }}
          QIITA_PAGES: ${{ env.QIITA_PAGES }}
          QIITA_TOKEN: ${{ env.QIITA_TOKEN }}
        run: npx --yes tsx@^4 scripts/collect-tech.fixed.ts
        npx --yes tsx@^4 scripts/postfilter-books.ts

      - name: Commit ranking.json (if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/data/ranking.json
          git commit -m "chore(data): update ranking.json [skip ci]" || echo "No changes to commit"
          git push || true

      - name: Trigger Vercel deploy (if hook set)
        if: ${{ env.VERCEL_DEPLOY_HOOK_URL != '' }}
        run: curl -sS -X POST "$VERCEL_DEPLOY_HOOK_URL" || true

